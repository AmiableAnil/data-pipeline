package org.sunbird.job.publish.helpers.spec

import akka.dispatch.ExecutionContexts
import com.typesafe.config.{Config, ConfigFactory}
import org.scalatest.{BeforeAndAfterAll, FlatSpec, Matchers}
import org.scalatestplus.mockito.MockitoSugar
import org.sunbird.job.content.publish.helpers.ExtractableMimeTypeHelper
import org.sunbird.job.content.task.ContentPublishConfig
import org.sunbird.job.publish.core.ObjectData
import org.sunbird.job.publish.util.CloudStorageUtil

class ExtractableMimeTypeHelperSpec extends FlatSpec with BeforeAndAfterAll with Matchers with MockitoSugar {

  implicit val ec = ExecutionContexts.global
  val config: Config = ConfigFactory.load("test.conf").withFallback(ConfigFactory.systemEnvironment())
  val jobConfig: ContentPublishConfig = new ContentPublishConfig(config)
  implicit val cloudStorageUtil = new CloudStorageUtil(jobConfig)

  def delay(time: Long): Unit = {
    try {
      Thread.sleep(time)
    } catch {
      case ex: Exception => print("")
    }
  }

  "processECMLBody " should " process the ecml body" in {
    val obj: ObjectData = new ObjectData("do_113188615625731",
      Map[String, AnyRef]("identifier" -> "do_113188615625731", "objectType" -> "Content", "mimeType" -> "application/vnd.ekstep.ecml-archive", "primaryCategory" -> "some category", "name" -> "Some Content", "code" -> "some code"),
      Some(Map[String, AnyRef]("body" -> "<theme startStage=\"1dafad29-7454-fb86-6a6f-e5262d127a1c\" compatibilityVersion=\"2\" version=\"1.0\" id=\"theme\"><manifest><media plugin=\"org.ekstep.navigation\" id=\"org.ekstep.navigation_js\" ver=\"1.0\" src=\"content-plugins/org.ekstep.navigation-1.0/renderer/controller/navigation_ctrl.js\" type=\"js\"></media><media plugin=\"org.ekstep.navigation\" id=\"org.ekstep.navigation_html\" ver=\"1.0\" src=\"content-plugins/org.ekstep.navigation-1.0/renderer/templates/navigation.html\" type=\"js\"></media><media plugin=\"org.ekstep.navigation\" id=\"org.ekstep.navigation\" ver=\"1.0\" src=\"content-plugins/org.ekstep.navigation-1.0/renderer/plugin.js\" type=\"plugin\"></media><media plugin=\"org.ekstep.navigation\" id=\"org.ekstep.navigation_manifest\" ver=\"1.0\" src=\"content-plugins/org.ekstep.navigation-1.0/manifest.json\" type=\"json\"></media><media plugin=\"org.ekstep.iterator\" id=\"org.ekstep.iterator\" ver=\"1.0\" src=\"content-plugins/org.ekstep.iterator-1.0/renderer/plugin.js\" type=\"plugin\"></media><media plugin=\"org.ekstep.iterator\" id=\"org.ekstep.iterator_manifest\" ver=\"1.0\" src=\"content-plugins/org.ekstep.iterator-1.0/manifest.json\" type=\"json\"></media><media plugin=\"org.ekstep.questionset\" id=\"org.ekstep.questionset_telemetry_logger_js\" ver=\"1.0\" src=\"content-plugins/org.ekstep.questionset-1.0/renderer/utils/telemetry_logger.js\" type=\"js\"></media><media plugin=\"org.ekstep.questionset\" id=\"org.ekstep.questionset_audio_plugin_js\" ver=\"1.0\" src=\"content-plugins/org.ekstep.questionset-1.0/renderer/utils/html_audio_plugin.js\" type=\"js\"></media><media plugin=\"org.ekstep.questionset\" id=\"org.ekstep.questionset_feedback_popup_js\" ver=\"1.0\" src=\"content-plugins/org.ekstep.questionset-1.0/renderer/utils/qs_feedback_popup.js\" type=\"js\"></media><media plugin=\"org.ekstep.questionset\" id=\"org.ekstep.questionset\" ver=\"1.0\" src=\"content-plugins/org.ekstep.questionset-1.0/renderer/plugin.js\" type=\"plugin\"></media><media plugin=\"org.ekstep.questionset\" id=\"org.ekstep.questionset_manifest\" ver=\"1.0\" src=\"content-plugins/org.ekstep.questionset-1.0/manifest.json\" type=\"json\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit.renderer.audioicon\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/assets/audio-icon.png\" type=\"image\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit.renderer.downarrow\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/assets/down_arrow.png\" type=\"image\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit_js\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/components/js/components.js\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit_css\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/components/css/components.css\" type=\"css\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/plugin.js\" type=\"plugin\"></media><media plugin=\"org.ekstep.questionunit\" id=\"org.ekstep.questionunit_manifest\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/manifest.json\" type=\"json\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml_manifest\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/manifest.json\" type=\"json\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml.plugin_js\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/renderer/plugin.js\" type=\"plugin\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml.feedback_popup\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/renderer/utils/quml_feedback_popup.js\" type=\"js\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml.feedback_close\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/renderer/assets/feedback-close.svg\" type=\"image\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml.play\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/renderer/assets/player-play-button.png\" type=\"image\"></media><media plugin=\"org.sunbird.questionunit.quml\" id=\"org.sunbird.questionunit.quml_css\" ver=\"1.1\" src=\"content-plugins/org.sunbird.questionunit.quml-1.1/renderer/styles/style.css\" type=\"css\"></media><media plugin=\"org.ekstep.questionunit\" id=\"4b2b66a2-9c5b-42d5-891d-ec0c3d1d516c\" ver=\"1.1\" src=\"/content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/katex.min.js\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"7e02c56a-c048-444d-bb2a-d4b854723adc\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/katex.min.css\" type=\"css\"></media><media plugin=\"org.ekstep.questionunit\" id=\"04ad980a-88ac-4c55-a597-266e42240670\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_main-bold.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"75ab3bcd-2c52-47b0-8b46-b635256ce06a\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_main-bolditalic.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"098cc69e-8658-483e-8597-8c392a1b3545\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_main-italic.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"102d1165-9544-480b-9ec1-1cb83937e650\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_main-regular.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"3bc5dce9-51ca-4a59-a0d9-d87d47c44670\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_math-bolditalic.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"a95bb693-d688-4e7a-a9bc-08e0cb6d1d62\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_math-italic.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"15757105-9023-4773-ba2a-8e619a0dc3a6\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_math-regular.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"5b1a9e58-8b7e-4295-a90d-593dc831262a\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_size1-regular.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"bc6ee547-9db0-480e-b298-b5509d43207a\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_size2-regular.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"35b0245e-d7d3-4ac0-9cac-6c2c328c8948\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_size3-regular.ttf\" type=\"js\"></media><media plugin=\"org.ekstep.questionunit\" id=\"80a19118-48eb-4859-9b0c-576a90a01148\" ver=\"1.1\" src=\"content-plugins/org.ekstep.questionunit-1.1/renderer/libs/katex/fonts/katex_size4-regular.ttf\" type=\"js\"></media></manifest><stage x=\"0\" y=\"0\" id=\"1dafad29-7454-fb86-6a6f-e5262d127a1c\" h=\"100\" w=\"100\"><config><![CDATA[{'opacity':100,'strokeWidth':1,'stroke':'rgba(255, 255, 255, 0)','autoplay':false,'visible':true,'color':'#FFFFFF','genieControls':false,'instructions':''}]]></config><org.ekstep.questionset z-index=\"0\" x=\"9\" y=\"6\" rotate=\"0\" id=\"69672a7f-a428-a510-607f-e5f14c050915\" h=\"85\" w=\"80\"><data><![CDATA[[{\"identifier\":\"69672a7f-a428-a510-607f-e5f14c050915\"}]]]></data><config><![CDATA[{\"max_score\":1,\"allow_skip\":true,\"show_feedback\":true,\"shuffle_questions\":false,\"shuffle_options\":false,\"total_items\":1}]]></config><org.ekstep.question x=\"9\" y=\"6\" pluginId=\"org.sunbird.questionunit.quml\" id=\"54acb83e-e6a7-32c6-5cb6-29d16586ccc6\" templateId=\"qumltemplate\" h=\"85\" type=\"quml\" w=\"80\" pluginVer=\"1.1\"><data><![CDATA[{\"question\":\"<div class='mcq-horizontal cheveron-helper'><div class='mcq-title'><p>A person having less ‘haemoglobin’ is suffering from:</p></div><i class='chevron down icon'></i><div class='mcq-options'><div data-simple-choice-interaction data-response-variable='responseValue' value=0 class='mcq-option'><p>Jaundice</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=1 class='mcq-option'><p>Anaemia</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=2 class='mcq-option'><p>Malaria</p></div><div data-simple-choice-interaction data-response-variable='responseValue' value=3 class='mcq-option'><p>Chikungunya</p></div></div></div>\",\"media\":[],\"responseDeclaration\":{\"responseValue\":{\"cardinality\":\"single\",\"type\":\"integer\",\"correct_response\":{\"value\":\"2\"}}},\"options\":[{\"answer\":false,\"value\":{\"type\":\"text\",\"body\":\"<p>Jaundice</p>\",\"resvalue\":0,\"resindex\":0}},{\"answer\":false,\"value\":{\"type\":\"text\",\"body\":\"<p>Anaemia</p>\",\"resvalue\":1,\"resindex\":1}},{\"answer\":true,\"value\":{\"type\":\"text\",\"body\":\"<p>Malaria</p>\",\"resvalue\":2,\"resindex\":2}},{\"answer\":false,\"value\":{\"type\":\"text\",\"body\":\"<p>Chikungunya</p>\",\"resvalue\":3,\"resindex\":3}}],\"questionCount\":0}]]></data><config><![CDATA[{\"max_score\":1,\"partial_scoring\":false,\"isShuffleOption\":false,\"responseDeclaration\":{},\"metadata\":{\"itemType\":\"UNIT\",\"code\":\"e8c45c21-82ac-de15-1885-5ae030639a2c\",\"subject\":\"Environmental Studies\",\"qlevel\":\"MEDIUM\",\"qumlVersion\":1,\"channel\":\"01309282781705830427\",\"responseDeclaration\":{\"responseValue\":{\"cardinality\":\"single\",\"type\":\"integer\",\"correct_response\":{\"value\":\"2\"}}},\"language\":[\"English\"],\"medium\":\"English\",\"type\":\"mcq\",\"templateId\":\"mcq-horizontal\",\"createdOn\":\"2021-02-10T08:39:21.748+0000\",\"gradeLevel\":[\"Class 5\"],\"appId\":\"dev.dock.portal\",\"lastUpdatedOn\":\"2021-02-10T08:41:04.338+0000\",\"identifier\":\"do_1132132565954396161724\",\"creator\":\"N18\",\"lastStatusChangedOn\":\"2021-02-10T08:39:21.748+0000\",\"author\":\"N18\",\"maxScore\":1,\"version\":3,\"versionKey\":\"1612946464338\",\"framework\":\"ekstep_ncert_k-12\",\"rejectComment\":\"\",\"name\":\"mcq_ekstep_ncert_k-12\",\"category\":\"MCQ\",\"board\":\"CBSE\",\"programId\":\"0c0246b0-6b7a-11eb-aec2-119aec14cb6e\",\"status\":\"Draft\"}}]]></config></org.ekstep.question></org.ekstep.questionset></stage><plugin-manifest><plugin depends=\"\" id=\"org.ekstep.navigation\" ver=\"1.0\" type=\"plugin\"></plugin><plugin depends=\"\" id=\"org.ekstep.questionunit\" ver=\"1.1\" type=\"plugin\"></plugin><plugin depends=\"\" id=\"org.ekstep.iterator\" ver=\"1.0\" type=\"plugin\"></plugin><plugin depends=\"org.ekstep.questionset.quiz,org.ekstep.iterator\" id=\"org.ekstep.questionset\" ver=\"1.0\" type=\"plugin\"></plugin><plugin depends=\"org.ekstep.questionunit\" id=\"org.sunbird.questionunit.quml\" ver=\"1.1\" type=\"plugin\"></plugin></plugin-manifest></theme>"))
    )
    ExtractableMimeTypeHelper.processECMLBody(obj, jobConfig)(ec, cloudStorageUtil)
  }

}
